<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expiry Date Analyzer</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: auto; /* Allow scrolling on mobile */
            transition: background-color 0.5s ease; /* Smooth background transition */
        }
        
        /* Custom background classes for status control */
        .bg-expired { background-color: #fee2e2; } /* Red 100 */
        .bg-unexpired { background-color: #ecfdf5; } /* Green/Teal 50 */
        .bg-caution { background-color: #fffbeb; } /* Amber 50 */

        /* Enhanced card shadows for a lifted, glassmorphism effect */
        .card-shadow {
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 10;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: box-shadow 0.5s ease, border-color 0.5s ease;
        }

        /* Specific card shadow glows */
        .shadow-default {
             box-shadow: 0 20px 40px -10px rgba(20, 184, 166, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.2);
        }
        .shadow-expired {
            box-shadow: 0 20px 40px -10px rgba(239, 68, 68, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.2);
        }
        .shadow-unexpired {
            box-shadow: 0 20px 40px -10px rgba(16, 185, 129, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.2);
        }
        .shadow-caution {
            box-shadow: 0 20px 40px -10px rgba(245, 158, 11, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.2);
        }

        /* --- Enhanced Capsule Flow Animation (Top-to-Bottom) --- */
        .capsule-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
            pointer-events: none;
        }

        .capsule {
            position: absolute;
            display: block;
            list-style: none;
            width: 20px;
            height: 20px;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.3), rgba(20, 184, 166, 0.4)); /* Gradient for 3D effect */
            animation: flow 20s linear infinite;
            top: -150px; /* Start above the viewport */
            border-radius: 50%;
            opacity: 0;
            box-shadow: 0 0 10px rgba(20, 184, 166, 0.5); /* Soft glow */
        }

        .capsule:nth-child(2n) {
            background: linear-gradient(45deg, rgba(59, 130, 246, 0.3), rgba(16, 185, 129, 0.4)); /* Blue-teal variation */
        }

        .capsule:nth-child(3n) {
            background: linear-gradient(45deg, rgba(245, 158, 11, 0.3), rgba(20, 184, 166, 0.4)); /* Amber-teal for warmth */
        }

        /* Capsule shape using transform */
        .capsule::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            transform: rotate(45deg) scaleX(1.8);
            opacity: 0.9;
            background: inherit;
        }

        /* Randomized properties for 20 capsules (increased for density) */
        .capsule:nth-child(1) { left: 5%; width: 30px; height: 10px; animation-delay: 0s; animation-duration: 15s; }
        .capsule:nth-child(2) { left: 15%; width: 15px; height: 5px; animation-delay: 2s; animation-duration: 20s; }
        .capsule:nth-child(3) { left: 25%; width: 25px; height: 8px; animation-delay: 4s; animation-duration: 18s; }
        .capsule:nth-child(4) { left: 35%; width: 10px; height: 4px; animation-delay: 0s; animation-duration: 25s; }
        .capsule:nth-child(5) { left: 45%; width: 22px; height: 7px; animation-delay: 7s; animation-duration: 10s; }
        .capsule:nth-child(6) { left: 55%; width: 35px; height: 12px; animation-delay: 3s; animation-duration: 30s; }
        .capsule:nth-child(7) { left: 65%; width: 18px; height: 6px; animation-delay: 10s; animation-duration: 14s; }
        .capsule:nth-child(8) { left: 70%; width: 28px; height: 9px; animation-delay: 6s; animation-duration: 22s; }
        .capsule:nth-child(9) { left: 75%; width: 12px; height: 4px; animation-delay: 8s; animation-duration: 16s; }
        .capsule:nth-child(10) { left: 85%; width: 20px; height: 7px; animation-delay: 1s; animation-duration: 19s; }
        .capsule:nth-child(11) { left: 10%; width: 15px; height: 5px; animation-delay: 12s; animation-duration: 25s; }
        .capsule:nth-child(12) { left: 30%; width: 25px; height: 8px; animation-delay: 5s; animation-duration: 12s; }
        .capsule:nth-child(13) { left: 50%; width: 30px; height: 10px; animation-delay: 15s; animation-duration: 20s; }
        .capsule:nth-child(14) { left: 60%; width: 10px; height: 4px; animation-delay: 9s; animation-duration: 18s; }
        .capsule:nth-child(15) { left: 80%; width: 22px; height: 7px; animation-delay: 11s; animation-duration: 13s; }
        .capsule:nth-child(16) { left: 20%; width: 18px; height: 6px; animation-delay: 13s; animation-duration: 17s; }
        .capsule:nth-child(17) { left: 40%; width: 26px; height: 9px; animation-delay: 14s; animation-duration: 21s; }
        .capsule:nth-child(18) { left: 90%; width: 14px; height: 5px; animation-delay: 16s; animation-duration: 23s; }
        .capsule:nth-child(19) { left: 95%; width: 32px; height: 11px; animation-delay: 17s; animation-duration: 11s; }
        .capsule:nth-child(20) { left: 0%; width: 24px; height: 8px; animation-delay: 18s; animation-duration: 26s; }

        @keyframes flow {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(1000px) rotate(360deg); /* Flow to bottom */
                opacity: 0;
            }
        }

        /* Additional creative animations */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .bounce { animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-10px); } 60% { transform: translateY(-5px); } }

        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(20, 184, 166, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(20, 184, 166, 0); } 100% { box-shadow: 0 0 0 0 rgba(20, 184, 166, 0); } }
    </style>
</head>
<body id="appBody" class="min-h-screen flex items-start justify-center p-4 sm:p-8 bg-unexpired">

    <!-- Enhanced Capsule Flow Background -->
    <div class="capsule-bg">
        <div class="capsule"></div>
        <div class="capsule"></div>
        <div class="capsule"></div>
        <div class="capsule"></div>
        <div class="capsule"></div>
        <div class="capsule"></div>
        <div class="capsule"></div>
        <div class="capsule"></div>
        <div class="capsule"></div>
        <div class="capsule"></div>
        <div class="capsule"></div>
        <div class="capsule"></div>
        <div class="capsule"></div>
        <div class="capsule"></div>
        <div class="capsule"></div>
        <div class="capsule"></div>
        <div class="capsule"></div>
        <div class="capsule"></div>
        <div class="capsule"></div>
        <div class="capsule"></div>
    </div>
    <!-- End Capsule Flow Background -->

    <div id="mainContentCard" class="w-full max-w-4xl card-shadow rounded-2xl p-6 sm:p-10 mt-8 fade-in shadow-default">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 text-center mb-4">
            EXPIRE EYE
        </h1>
        <p class="text-center text-gray-500 mb-8 text-lg">
            Snap,Scan,Stay Safe! ✨
        </p>

        <!-- API Configuration Note - Updated to Teal -->
        <br>
        
        <!-- Image Input and Preview -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
            <!-- Upload Column -->
            <div class="space-y-6">
                <label for="imageUpload" class="block text-xl font-bold text-gray-700 flex items-center">
                       1. Upload Product Label Image
                </label>
                <input type="file" id="imageUpload" accept="image/*" class="w-full border border-gray-300 rounded-lg p-3 text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100 cursor-pointer" aria-label="Upload an image of the product label" />
                
                <button id="analyzeButton" 
                        class="w-full py-4 px-4 bg-teal-600 text-white font-bold rounded-xl shadow-lg shadow-teal-300/50 hover:bg-teal-700 hover:scale-105 hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-teal-500 focus:ring-opacity-50 transition duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed text-lg"
                        disabled aria-label="Start the expiry analysis">
                        Start Expiry Analysis
                </button>

                <div id="loadingIndicator" class="hidden text-center text-teal-600 font-semibold py-2">
                    <svg class="animate-spin bounce -ml-1 mr-3 h-6 w-6 text-teal-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Processing with YOLO and OCR... 
                </div>
            </div>

            <!-- Preview Column -->
            <div class="border-4 border-dashed border-gray-300 bg-gray-50 rounded-xl overflow-hidden shadow-inner flex items-center justify-center p-4 h-64 hover:border-teal-400 transition duration-300" aria-label="Image preview area">
                <img id="imagePreview" src="https://placehold.co/400x256/D1D5DB/4B5563?text=Drag+or+Upload+Image" alt="Product Preview" class="max-h-full max-w-full object-contain rounded-lg">
            </div>
        </div>

        <div class="mb-8 border-b border-gray-200"></div>
        
        <!-- Results Display -->
        <h2 class="text-2xl font-bold text-gray-800 mb-6"> 2. Analysis Summary</h2>
        
        <div id="resultsContainer" class="p-6 border-2 rounded-xl space-y-4 transition-all duration-300 bg-gray-50">
            <p id="resultStatus" class="text-xl font-bold text-gray-500">
                Awaiting product image... ⏳
            </p>
            
            <div id="resultMessage" class="text-gray-700 text-base">
                Upload an image and hit "Start Expiry Analysis" to begin the magic!
            </div>

            <div id="resultDetails" class="hidden pt-4 border-t border-gray-200 space-y-2 text-sm">
                <p><strong>Extracted Text:</strong> <code id="extractedText" class="bg-gray-100 p-1 rounded font-mono break-all text-xs sm:text-sm">N/A</code></p>
                <p><strong>Classified Date:</strong> <code id="classifiedDate" class="bg-gray-100 p-1 rounded font-mono text-sm sm:text-base">N/A</code></p>
            </div>
        </div>

    </div>

    <script>
        const API_URL = "http://127.0.0.1:8000/analyze_product";
        
        const appBody = document.getElementById('appBody');
        const mainContentCard = document.getElementById('mainContentCard');
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const analyzeButton = document.getElementById('analyzeButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultsContainer = document.getElementById('resultsContainer');
        const resultStatus = document.getElementById('resultStatus');
        const resultMessage = document.getElementById('resultMessage');
        const resultDetails = document.getElementById('resultDetails');
        const extractedText = document.getElementById('extractedText');
        const classifiedDate = document.getElementById('classifiedDate');

        let base64Image = null;

        // Utility classes for easy removal
        const BODY_BGS = ['bg-expired', 'bg-unexpired', 'bg-caution'];
        const CARD_SHADOWS = ['shadow-default', 'shadow-expired', 'shadow-unexpired', 'shadow-caution'];

        // --- Utility Functions ---

        /**
         * Converts a File object to a Base64 string.
         * @param {File} file 
         * @returns {Promise<string>} Base64 string (data:image/...)
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                // Get the base64 data part only (split(',')[1])
                reader.onload = () => resolve(reader.result.split(',')[1]); 
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        /**
         * Clears all status indicators to a default state and sets the default background.
         */
        function resetResults() {
            // Reset main page background to default (Unexpired/Teal)
            appBody.classList.remove(...BODY_BGS);
            appBody.classList.add('bg-unexpired');

            // Reset card shadow to default
            mainContentCard.classList.remove(...CARD_SHADOWS);
            mainContentCard.classList.add('shadow-default');

            // Default state for container
            resultsContainer.className = 'p-6 border-2 border-gray-200 rounded-xl space-y-4 transition-all duration-300 bg-gray-50';
            
            // Default state for text
            resultStatus.className = 'text-xl font-bold text-gray-500';
            resultStatus.textContent = 'Awaiting analysis...';
            resultMessage.textContent = 'Upload an image and click the "Start Expiry Analysis" button.';
            
            // Hide details
            resultDetails.classList.add('hidden');
            extractedText.textContent = 'N/A';
            classifiedDate.textContent = 'N/A';
        }

        /**
         * Updates the results panel and page background based on the server response.
         * @param {object} data - The JSON response from the server.
         */
        function updateResults(data) {
            const status = data.status;
            let statusColor = 'bg-gray-50 border-gray-400';
            let statusTextColor = 'text-gray-800';
            let bodyBgClass = 'bg-caution'; // Default to yellow/caution
            let cardShadowClass = 'shadow-caution'; // Default to yellow/caution
            
            // Clear previous background and shadow classes
            appBody.classList.remove(...BODY_BGS);
            mainContentCard.classList.remove(...CARD_SHADOWS);

            // Set styles based on status
            switch (status) {
                case 'UNEXPIRED':
                    // Green/Teal for good status
                    statusColor = 'bg-teal-50 border-teal-600 shadow-lg shadow-teal-100';
                    statusTextColor = 'text-teal-700';
                    bodyBgClass = 'bg-unexpired';
                    cardShadowClass = 'shadow-unexpired';
                    break;
                case 'EXPIRING_SOON':
                    // Orange/Yellow for caution
                    statusColor = 'bg-amber-50 border-amber-500 shadow-lg shadow-amber-100';
                    statusTextColor = 'text-amber-700';
                    bodyBgClass = 'bg-caution';
                    cardShadowClass = 'shadow-caution';
                    break;
                case 'EXPIRED':
                    // Red for danger
                    statusColor = 'bg-red-50 border-red-600 shadow-lg shadow-red-100';
                    statusTextColor = 'text-red-700';
                    bodyBgClass = 'bg-expired';
                    cardShadowClass = 'shadow-expired';
                    break;
                case 'UNDETERMINED':
                case 'MFG_DATE':
                case 'ERROR':
                    // Use caution/yellow for errors or unclassified statuses
                    statusColor = 'bg-blue-50 border-blue-500 shadow-lg shadow-blue-100';
                    statusTextColor = 'text-blue-700';
                    bodyBgClass = 'bg-caution';
                    cardShadowClass = 'shadow-caution';
                    break;
                default:
                    // Fallback to caution/yellow for unknown status
                    statusColor = 'bg-amber-50 border-amber-500 shadow-lg shadow-amber-100';
                    statusTextColor = 'text-amber-700';
                    bodyBgClass = 'bg-caution';
                    cardShadowClass = 'shadow-caution';
                    break;
            }

            // Apply new body and card shadow classes
            appBody.classList.add(bodyBgClass);
            mainContentCard.classList.add(cardShadowClass);

            // Update container styles
            resultsContainer.className = `p-6 border-2 rounded-xl space-y-4 transition-all duration-300 ${statusColor}`;

            // Update status text
            resultStatus.className = `text-xl font-bold ${statusTextColor}`;
            resultStatus.textContent = data.title || `Status: ${status}`;

            // Update message and details
            resultMessage.textContent = data.message || 'No specific message provided.';
            
            extractedText.textContent = data.extracted_text || 'None detected.';
            classifiedDate.textContent = data.classified_date || 'N/A';

            // Show details panel unless it's a simple error
            if (status !== 'ERROR') {
                resultDetails.classList.remove('hidden');
            } else {
                 resultDetails.classList.add('hidden');
            }
        }

        /**
         * Sends the base64 image data to the FastAPI backend for analysis.
         */
        async function analyzeProduct() {
            if (!base64Image) {
                updateResults({
                    title: "Error: No Image",
                    message: "Please upload a product label image first.",
                    status: "ERROR",
                    extracted_text: "N/A",
                    classified_date: "N/A"
                });
                return;
            }

            // Show loading state
            analyzeButton.disabled = true;
            loadingIndicator.classList.remove('hidden');
            resetResults(); // Reset initial colors while loading
            resultStatus.textContent = 'Processing Image...';
            resultsContainer.classList.add('pulse');

            try {
                // Exponential backoff retry logic
                let response;
                let data = null;
                let attempts = 0;
                const maxAttempts = 5;
                let success = false;
                let lastError = null;

                while (attempts < maxAttempts && !success) {
                    attempts++;
                    try {
                        const timeout = attempts > 1 ? Math.pow(2, attempts - 1) * 1000 : 0; // 0s, 2s, 4s, 8s, ...
                        if (timeout > 0) await new Promise(resolve => setTimeout(resolve, timeout));

                        response = await fetch(API_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ image_base64: base64Image }),
                        });

                        if (!response.ok) {
                            let errorDetail = `HTTP error! Status: ${response.status}`;
                            try {
                                const errorJson = await response.json();
                                errorDetail = errorJson.detail ? `HTTP error! Status: ${response.status}. Detail: ${JSON.stringify(errorJson.detail)}` : errorDetail;
                            } catch (e) {
                                // Ignore JSON parse error if body is empty or not JSON
                            }
                            throw new Error(errorDetail);
                        }

                        data = await response.json();
                        success = true;

                    } catch (error) {
                        lastError = error;
                        if (attempts === maxAttempts) {
                            throw lastError; // Throw the error if max attempts reached
                        }
                    }
                }

                updateResults(data);

            } catch (error) {
                console.error('Analysis error:', error);
                // Display error to the user
                updateResults({
                    title: "Connection Error",
                    message: `Could not connect to the API server at ${API_URL}. Please ensure the Python server is running and the endpoint is correct. Error: ${error.message}`,
                    status: "ERROR",
                    extracted_text: "N/A",
                    classified_date: "N/A"
                });
            } finally {
                // Hide loading state
                analyzeButton.disabled = false;
                loadingIndicator.classList.add('hidden');
                resultsContainer.classList.remove('pulse');
            }
        }

        // --- Event Listeners ---

        imageUpload.addEventListener('change', async (event) => {
            resetResults(); // Reset when a new file is chosen
            const file = event.target.files[0];
            if (file) {
                try {
                    // Update preview
                    imagePreview.src = URL.createObjectURL(file);
                    
                    // Store Base64 data for API call
                    base64Image = await fileToBase64(file); 
                    
                    analyzeButton.disabled = false; // Enable button
                    
                    resultStatus.textContent = 'Image Ready. Press Analyze.';
                    resultStatus.className = 'text-xl font-bold text-teal-600';
                    resultMessage.textContent = `File loaded: ${file.name}. Click 'Start Expiry Analysis' to check its freshness.`;
                    resultDetails.classList.add('hidden');

                } catch (error) {
                    console.error('File reading error:', error);
                    base64Image = null;
                    imagePreview.src = "https://placehold.co/400x256/D1D5DB/4B5563?text=Upload+Error";
                    analyzeButton.disabled = true;
                    updateResults({
                        title: "File Error",
                        message: "Could not read the image file. Please try a different one.",
                        status: "ERROR",
                        extracted_text: "N/A",
                        classified_date: "N/A"
                    });
                }
            } else {
                base64Image = null;
                imagePreview.src = "https://placehold.co/400x256/D1D5DB/4B5563?text=Drag+or+Upload+Image";
                analyzeButton.disabled = true;
                resetResults();
            }
        });

        analyzeButton.addEventListener('click', analyzeProduct);
        
        // Initial setup for default colors
        window.onload = resetResults;
    </script>
</body>
</html>
